<?php $title = PROJECT_NAME." | ".Localization::$s_edit_order; include_once('header.inc.html'); ?>
<script language="JavaScript" src="js/radio_handler.js" ></script>
	<h1>
		<strong>
			<?php echo(Localization::$s_edit_order); ?>
			<?php if (isset($orderId)) {?>
			&nbsp;|&nbsp;<?php echo($replacementingUserIdInfo[$orderId]['user_name']); ?>
			<?php }?>
		</strong>
	</h1>

<?php if (!empty($error)) {?>
	<?php foreach ($error AS $item){?>
		<font color="red"><?php echo($item); ?></font><br />
	<?php }?>
<?php }?>
<?php if (!empty($message)) {?>
	<?php foreach ($message AS $item){?>
		<font color="green"><?php echo($item); ?></font><br />
	<?php }?>
<?php }?>

<?php if (!empty($weekInfo) && !empty($providerToIdList) && !empty($dayList)) {?>

<h3>
	<?php if (!isset($_GET['text_mode'])) {?>
		<b>
			<?php echo(Localization::$s_edit_mode); ?>
		</b>
		&nbsp;|&nbsp;
		<a href="<?php echo($scriptName); ?>?<?php if (isset($_GET['next_week'])){?>next_week&<?php }?>order_id=<?php echo($orderId); ?>&text_mode&edit=<?php echo($userInfo['user_id']); ?>">
			<?php echo(Localization::$s_text_mode); ?>
		</a>
	<?php } else {?>
		<a href="<?php echo($scriptName); ?>?<?php if (isset($_GET['next_week'])){?>next_week&<?php }?>order_id=<?php echo($orderId); ?>&edit_mode&edit=<?php echo($userInfo['user_id']); ?>">
			<?php echo(Localization::$s_edit_mode); ?>
		</a>
		&nbsp;|&nbsp;
		<b>
			<?php echo(Localization::$s_text_mode); ?>
		</b>
	<?php }?>
</h3>

<?php if(!empty($nextWeekInfo) || !empty($prevWeekInfo)) {?>
	<?php if(!empty($nextWeekInfo)) {?>
		<b>
			<?php echo(Localization::$s_curent); ?>:&nbsp;<?php echo(htmlspecialchars($weekInfo['name'])); ?>
		</b>
		&nbsp;|&nbsp;
		<a href="<?php echo($scriptName); ?>?next_week&order_id=<?php echo($orderId); ?>&<?php if (isset($_GET['text_mode'])){?>text_mode<?php } else {?>edit_mode<?php }?>&edit=<?php echo($userInfo['user_id']); ?>">
			<?php echo(Localization::$s_next); ?>:&nbsp;<?php echo(htmlspecialchars($nextWeekInfo['name'])); ?>
		</a>
	<?php } else {?>
		<a href="<?php echo($scriptName); ?>?order_id=<?php echo($orderId); ?>&<?php if (isset($_GET['text_mode'])){?>text_mode<?php } else {?>edit_mode<?php }?>&edit=<?php echo($userInfo['user_id']); ?>">
			<?php echo(Localization::$s_curent); ?>:&nbsp;<?php echo(htmlspecialchars($prevWeekInfo['name'])); ?>
		</a>
		&nbsp;|&nbsp;
		<b>
			<?php echo(Localization::$s_next); ?>:&nbsp;<?php echo(htmlspecialchars($weekInfo['name'])); ?>
		</b>
	<?php }?>
<?php } else {?>
	<h2><?php echo(htmlspecialchars($weekInfo['name'])); ?></h2>
<?php }?>
<hr />
<form method="get" action="orders.php">
	<?php if (isset($orderId)) {?>
		<input type="submit" name="i_am_lucky" value="<?php echo(Localization::$s_he_is_lucky); ?>" onclick="return confirm('<?php echo(Localization::$m_are_you_sure_to_gen_random_lounch); ?>')"/>
		<input type="hidden" name="order_id" value="<?php echo($orderId); ?>" />
	<?php } else {?>
		<input type="submit" name="i_am_lucky" value="<?php echo(Localization::$s_i_am_lucky); ?>" onclick="return confirm('<?php echo(Localization::$m_are_you_sure_to_gen_random_lounch); ?>')"/>
	<?php }?>
	<?php if (isset($_GET['next_week'])) {?>
		<input type="hidden" name="next_week" value="1" />
	<?php }?>
</form>

<form name="edit_order_list" method="post" action="<?php echo($scriptName); ?>" class="cssform">
	<hr />
	<?php $radioCounter = 0?>
	<?php foreach ($dayList AS $dayItem) {?>
		<?php $paymentInfo = null;?>
		<?php $paymentAmount = 0;?>
		<?php if ($isAnyOrderForADay[$dayItem]) {?>
			<h2><?php switch($dayItem) {
					case D_MONDAY: 
						
						echo Localization::$s_monday;
						if ($fullWeekInfo[D_MONDAY])
						{
							echo "&nbsp;[".$fullWeekInfo[D_MONDAY]['day']." ".$fullWeekInfo[D_MONDAY]['monthname']."]";
						}
						break;
					case D_TUESDAY: 
						echo Localization::$s_tuesday;
						if ($fullWeekInfo[D_TUESDAY])
						{
							echo "&nbsp;[".$fullWeekInfo[D_TUESDAY]['day']." ".$fullWeekInfo[D_TUESDAY]['monthname']."]";
						}
						break;
					case D_WEDNESDAY:
						echo Localization::$s_wednesday;
						if ($fullWeekInfo[D_WEDNESDAY])
						{
							echo "&nbsp;[".$fullWeekInfo[D_WEDNESDAY]['day']." ".$fullWeekInfo[D_WEDNESDAY]['monthname']."]";
						}
						break;
					case D_THURSDAY: 
						echo Localization::$s_thursday;
						if ($fullWeekInfo[D_THURSDAY])
						{
							echo "&nbsp;[".$fullWeekInfo[D_THURSDAY]['day']." ".$fullWeekInfo[D_THURSDAY]['monthname']."]";
						}
						break;
					case D_FRIDAY: 
						echo Localization::$s_friday;
						if ($fullWeekInfo[D_FRIDAY])
						{
							echo "&nbsp;[".$fullWeekInfo[D_FRIDAY]['day']." ".$fullWeekInfo[D_FRIDAY]['monthname']."]";
						}
						break;
					case D_SATURDAY: 
						echo Localization::$s_saturday;
						if ($fullWeekInfo[D_SATURDAY])
						{
							echo "&nbsp;[".$fullWeekInfo[D_SATURDAY]['day']." ".$fullWeekInfo[D_SATURDAY]['monthname']."]";
						}
						break;
					case D_SUNDAY: 
						echo Localization::$s_sunday;
						if ($fullWeekInfo[D_SUNDAY])
						{
							echo "&nbsp;[".$fullWeekInfo[D_SUNDAY]['day']." ".$fullWeekInfo[D_SUNDAY]['monthname']."]";
						}
						break;
				}?>
			</h2>
			
			
			<?php if (!$isBlocked[$dayItem]) {?>
				<input  type="radio"  value="no" name="order_<?php echo($dayItem); ?>" id="a_order_<?php echo($dayItem); ?>" onClick="uncheckIfChecked(this)" 
				<?php if (!isset($userOrderId['day_'.$dayItem]['provider_id'])) {?>
					checked="checked"
					<?php }?>
				/><span onclick="checkRadioButton(document.edit_order_list.a_order_<?php echo($dayItem); ?>)"><?php echo(Localization::$s_no_order); ?></span>
			<?php }?>
			<?php if ($isBlocked[$dayItem] &&  empty($userDayOrder[$dayItem])) {?>
				<font color="red"><?php echo(Localization::$s_no_order); ?></font>
			<?php } else if ($isBlocked[$dayItem]) {?>
				<?php $paymentInfo = $userInfo['user_id']."_".$weekInfo['week_id'];?>
				<?php $noPayed = 0;?>
			<?php }?>
			
			<?php foreach($providerList AS $providerItem) {?>
				<?php if (PROVIDERS_MULTICHOICE == 1) { $providerFooter = "_".$providerItem['provider_id']; } else { $providerFooter = ""; }?>
				<?php if (($isBlocked[$dayItem] &&  empty($userDayOrder[$dayItem])) || ($isBlocked[$dayItem] && empty($userDayOrder[$dayItem][$providerItem['provider_id']]))) {?>
				<?php } else {?>
					<?php if (isset($providerToIdList[$providerItem['provider_id']]['order'][$dayItem])) {?>
						<b><h3>
						<?php if (!$isBlocked[$dayItem]) {?>
							<input type="radio" id="a_<?php echo($dayItem); ?>_<?php echo($providerItem['provider_id']); ?>" value="<?php echo($providerItem['provider_id']); ?>" name="order_<?php echo($dayItem); ?><?php echo($providerFooter); ?>" onClick="{uncheckIfChecked(this); uncheckRadioButton(document.edit_order_list.order_<?php echo($dayItem); ?>)}" 
							<?php if (isset($userOrderId['day_'.$dayItem][$providerItem['provider_id']])) {?>
								checked ="checked"
							<?php }?>
							/><span onClick="{uncheckIfChecked(document.edit_order_list.a_<?php echo($dayItem); ?>_<?php echo($providerItem['provider_id']); ?>); uncheckRadioButton(document.edit_order_list.order_<?php echo($dayItem); ?>)}"><?php echo(htmlspecialchars($providerItem['name'])); ?></span>
						<?php } else {?>

							<?php if (isset($userOrderId['day_'.$dayItem][$providerItem['provider_id']])) {?>
								<font color="green"><?php echo(htmlspecialchars($providerItem['name'])); ?></font>
							<?php } else {?>
								<?php echo(htmlspecialchars($providerItem['name'])); ?>
							<?php }?>
						<?php }?>
						</h3></b>
						<br />
						<table border="0">
							<tr>
								<td align="center"><b><?php echo(Localization::$s_first); ?></b></td>
								<td align="center"><b><?php echo(Localization::$s_second); ?></b></td>
								<td align="center"><b><?php echo(Localization::$s_third); ?></b></td>
								<td align="center"><b><?php echo(Localization::$s_fours); ?></b></td>
							</tr>
							
							<!--- Revolution !-->
							
							<tr>
							<?php for ($portion = 1; $portion<=4; $portion++) { $portionCounter = 1;?>
								<td valign="top">
									<?php if (isset($providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter])) {?>
										<table border="0" width="100%" height="100%">
										<?php while(isset($providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter])) {?>
											<?php if ($providerItem['multichoice'] != 0) { $footer = "_".$portionCounter; } else {$footer = "";}?>
											<?php if (!$isBlocked[$dayItem]) {?>
											<tr>
											<td>
											<input type="radio" id="provider_<?php echo($providerItem['provider_id']); ?>_<?php echo($dayItem); ?>_<?php echo($portion); ?><?php echo($footer); ?>_<?php echo($radioCounter); ?>" name="provider_<?php echo($providerItem['provider_id']); ?>_<?php echo($dayItem); ?>_<?php echo($portion); ?><?php echo($footer); ?>" value="<?php echo($providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_list_id']); ?>" onClick="{uncheckIfChecked(this); checkRadioButton(document.edit_order_list.a_<?php echo($dayItem); ?>_<?php echo($providerItem['provider_id']); ?>); uncheckRadioButton(document.edit_order_list.order_<?php echo($dayItem); ?>)}" 
											<?php if (isset($userOrderId['order'][$providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_list_id']])) {?>
											checked="checked" 
											<?php }?>
											 />
											 <span onClick="{uncheckIfChecked(document.edit_order_list.provider_<?php echo($providerItem['provider_id']); ?>_<?php echo($dayItem); ?>_<?php echo($portion); ?><?php echo($footer); ?>_<?php echo($radioCounter); ?>); checkRadioButton(document.edit_order_list.a_<?php echo($dayItem); ?>_<?php echo($providerItem['provider_id']); ?>); uncheckRadioButton(document.edit_order_list.order_<?php echo($dayItem); ?>)}" >
												<?php if (SHOW_PRICE_FOR_USER == 1) {?>
													[<?php echo(htmlspecialchars($providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_price'])); ?>&nbsp;<?php echo(PRICE_CURRENCY); ?>]
												<?php }?>
												<?php echo(htmlspecialchars($providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['portion_name'])); ?>
											</span>
											</td>
											<td>
											<?php if ($providerItem['multiitem'] != 0) {?>
												&nbsp;
												<input type="text" name="provider_<?php echo($providerItem['provider_id']); ?>_<?php echo($dayItem); ?>_<?php echo($portion); ?><?php echo($footer); ?>_count" value="<?php if ($userOrderId['order'][$providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_list_id']]['ordered_item_count'] > 0) { echo $userOrderId['order'][$providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_list_id']]['ordered_item_count']; } else {echo '1';}?>" size="3" onClick="{checkRadioButton(document.edit_order_list.provider_<?php echo($providerItem['provider_id']); ?>_<?php echo($dayItem); ?>_<?php echo($portion); ?><?php echo($footer); ?>_<?php echo($radioCounter); ?>); checkRadioButton(document.edit_order_list.a_<?php echo($dayItem); ?>_<?php echo($providerItem['provider_id']); ?>); uncheckRadioButton(document.edit_order_list.order_<?php echo($dayItem); ?>) }" />
											<?php }?>
											</td>
											</tr>
											
											
											
											
											<?php } else {?>
											<tr>
												<td>
												<?php if (isset($userOrderId['order'][$providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_list_id']])) {?>
												<?php if ($userOrderId['order'][$providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_list_id']]['ordered_amount'] == 0){ $noPayed = 1;?>
													<?php $paymentInfo .= "_".$userOrderId['order'][$providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_list_id']]['order_list_id']?>
												<?php }?>
												<font color="<?php if ($userOrderId['order'][$providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_list_id']]['ordered_amount'] == 0) {echo "yellow";} else {echo "green";} ?>">
												<b><h3>
												<?php if (SHOW_PRICE_FOR_USER == 1) {?>
													[<?php echo(htmlspecialchars($providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_price'])); ?>&nbsp;<?php echo(PRICE_CURRENCY); ?>]
												<?php }?>
												<?php echo(htmlspecialchars($providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['portion_name'])); ?>
												</td>
												<td>
												<?php if (($providerItem['multiitem'] != 0) && ($userOrderId['order'][$providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_list_id']]['ordered_item_count'] > 1)) {?>
													&nbsp;(x<?php echo($userOrderId['order'][$providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_list_id']]['ordered_item_count']); ?>)
												<?php }?>
												<?php if ($portion != 4 ) {?>
												, 
												<?php }?>
												</h3></b></font>
												</td>
												<?php $paymentAmount += $userOrderId['order'][$providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_list_id']]['ordered_item_count'] * $providerToIdList[$providerItem['provider_id']]['order'][$dayItem][$portion][$portionCounter]['order_price'];?>
												
												<?php $isOrdered = 1; } ?>
											</tr>
											<?php }?>
										<?php $portionCounter++; $radioCounter++; }?>
										</table>
									<?php } else {?>
										<?php echo(Localization::$m_no_menu_available); ?>
									<?php }?>
								</td>
						<?php }?>
							</tr>
							
							
							
						</table>
						<br />
					<?php }?>
				<?php }?>
			<?php }?>
			<?php if (($isLogged['status'] == 10) && ($isBlocked[$dayItem]) && (!empty($paymentInfo)) && ($noPayed)) {?>
				<a href="cash.php?order_payment=<?php echo($paymentInfo); ?>"><?php echo(Localization::$s_pay_for_order); ?>&nbsp;<?php echo($paymentAmount); ?>&nbsp;<?php echo(PRICE_CURRENCY); ?></a><br />
			<?php }?>
			<hr />
		<?php }?>
	<?php }?>
<p>
	<input type="hidden" name="week_id" value="<?php echo($weekInfo['week_id']); ?>" />
	<?php if (isset($_GET['next_week'])) {?>
		<input type="hidden" name="next_week" value="1" />
	<?php }?>
	<?php if (isset($orderId)) {?>
		<input type="hidden" name="order_id" value="<?php echo($orderId); ?>" />
	<?php }?>
	<input type="hidden" name="user_id" value="<?php echo($userInfo['user_id']); ?>" />
	<input type="submit" name="do_order_save" value="<?php echo(Localization::$s_save); ?>" />
</p>
</form>
<?php } else {?>
	<?php echo(Localization::$m_no_available_orders); ?>
<?php }?>
<?php include_once ('footer.inc.html'); ?>